version: '3.8'

# Gestoo Platform - Docker Compose Configuration
# National Accommodation Intelligence Platform for Senegal

services:
  # ===========================================
  # Redis for Session Management & Caching
  # ===========================================
  redis:
    image: redis:7-alpine
    container_name: gestoo-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
      - ./logs/redis:/var/log/redis
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - gestoo-network
    restart: unless-stopped

  # ===========================================
  # Chatbot Service - WhatsApp Integration
  # ===========================================
  chatbot:
    build:
      context: ..
      dockerfile: docker/Dockerfile.chatbot
      args:
        - NODE_ENV=production
    container_name: gestoo-chatbot
    ports:
      - "${CHATBOT_PORT:-4000}:4000"
    environment:
      - NODE_ENV=production
      - PORT=4000
      - REDIS_URL=redis://redis:6379
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - WATI_API_KEY=${WATI_API_KEY}
      - WATI_WEBHOOK_SECRET=${WATI_WEBHOOK_SECRET}
      - WHATSAPP_PHONE_NUMBER_ID=${WHATSAPP_PHONE_NUMBER_ID}
      - WHATSAPP_ACCESS_TOKEN=${WHATSAPP_ACCESS_TOKEN}
      - WHATSAPP_VERIFY_TOKEN=${WHATSAPP_VERIFY_TOKEN}
      - INTELLIGENCE_SERVICE_URL=http://intelligence:5000
    volumes:
      - ./logs/chatbot:/app/logs
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - gestoo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ===========================================
  # Scraper Service - Listing Detection
  # ===========================================
  scraper:
    build:
      context: ..
      dockerfile: docker/Dockerfile.scraper
      args:
        - NODE_ENV=production
    container_name: gestoo-scraper
    ports:
      - "${SCRAPER_PORT:-4001}:4001"
    environment:
      - NODE_ENV=production
      - PORT=4001
      - REDIS_URL=redis://redis:6379
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - SCRAPER_SCHEDULE=${SCRAPER_SCHEDULE:-0 */6 * * *}
      - SCRAPER_CONCURRENCY=${SCRAPER_CONCURRENCY:-3}
      - INTELLIGENCE_SERVICE_URL=http://intelligence:5000
    volumes:
      - ./logs/scraper:/app/logs
      - scraper_cache:/app/.cache
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - gestoo-network
    restart: unless-stopped
    # Puppeteer needs extra capabilities
    cap_add:
      - SYS_ADMIN
    security_opt:
      - seccomp=unconfined

  # ===========================================
  # Intelligence Service - Analytics & ML
  # ===========================================
  intelligence:
    build:
      context: ..
      dockerfile: docker/Dockerfile.intelligence
      args:
        - NODE_ENV=production
    container_name: gestoo-intelligence
    ports:
      - "${INTELLIGENCE_PORT:-5000}:5000"
    environment:
      - NODE_ENV=production
      - PORT=5000
      - REDIS_URL=redis://redis:6379
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      - ./logs/intelligence:/app/logs
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - gestoo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ===========================================
  # Nginx Reverse Proxy (Optional)
  # ===========================================
  nginx:
    image: nginx:alpine
    container_name: gestoo-nginx
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - chatbot
      - intelligence
    networks:
      - gestoo-network
    restart: unless-stopped
    profiles:
      - with-nginx

# ===========================================
# Volumes
# ===========================================
volumes:
  redis_data:
    name: gestoo-redis-data
  scraper_cache:
    name: gestoo-scraper-cache

# ===========================================
# Networks
# ===========================================
networks:
  gestoo-network:
    name: gestoo-network
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
